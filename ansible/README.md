# SpendWise Ansible Deployment

Ansible configuration for deploying the SpendWise application to AWS EC2.

## üìã Files

- **`inventory.ini`** - Defines target hosts and connection settings
- **`playbook.yml`** - Main deployment playbook
- **`ansible.cfg`** - Ansible configuration
- **`spendwise-dev-keypair.pem`** - SSH private key (generated by Terraform)

## üöÄ Quick Start

### 1. Verify SSH Connectivity

```bash
ansible webserver -m ping
```

### 2. Deploy the Application

```bash
ansible-playbook playbook.yml
```

### 3. Deploy with Verbose Output

```bash
ansible-playbook playbook.yml -v
# or for more detail:
ansible-playbook playbook.yml -vvv
```

## üéØ What the Playbook Does

1. ‚úÖ **System Update** - Updates all packages to latest versions
2. ‚úÖ **Install Prerequisites** - Installs Docker, Docker Compose, and Git
3. ‚úÖ **Configure Docker** - Starts Docker service and adds ubuntu user to docker group
4. ‚úÖ **Verify Installation** - Checks Docker and Docker Compose versions
5. ‚úÖ **Clone Repository** - Clones SpendWise from GitHub
6. ‚úÖ **Deploy Application** - Runs `docker-compose up -d --build`
7. ‚úÖ **Verify Deployment** - Checks running containers

## üìä Playbook Tags

Run specific parts of the playbook using tags:

```bash
# Update system only
ansible-playbook playbook.yml --tags "system"

# Install Docker and Docker Compose only
ansible-playbook playbook.yml --tags "docker,docker-compose"

# Deploy application only (assumes prerequisites are met)
ansible-playbook playbook.yml --tags "app"

# Skip certain tasks
ansible-playbook playbook.yml --skip-tags "update"
```

## üîç Useful Commands

### Check Connectivity
```bash
# Ping all hosts
ansible webserver -m ping

# Check disk space
ansible webserver -m command -a "df -h"

# Check memory
ansible webserver -m command -a "free -h"
```

### Application Management
```bash
# Check Docker containers
ansible webserver -m command -a "docker ps" -b --become-user=ubuntu

# View Docker logs
ssh -i spendwise-dev-keypair.pem ubuntu@<instance-ip>
docker-compose -f ~/SpendWise/docker-compose.yml logs -f

# Restart application
ansible webserver -m command -a "docker-compose restart" -b --become-user=ubuntu \
  --extra-vars "chdir=/home/ubuntu/SpendWise"
```

### SSH Access
```bash
# SSH into the server
ssh -i spendwise-dev-keypair.pem ubuntu@<instance-ip>

# Using inventory alias
ssh -F <(ansible-inventory --list | jq -r '.webserver.hosts[0]') ec2-user@spendwise-server
```

## üåê Access URLs

After deployment, access your application at:

- **Frontend**: `http://<instance-ip>:5173`
- **Backend API**: `http://<instance-ip>:5000`
- **Web (if configured)**: `http://<instance-ip>:80`

Get your instance IP:
```bash
ansible-inventory --list | jq -r '._meta.hostvars."spendwise-server".ansible_host'
# Or from Terraform:
cd ../terraform && terraform output instance_public_ip
```

## üîß Customization

### Update Repository URL
Edit `playbook.yml`:
```yaml
vars:
  repo_url: "https://github.com/YOUR_USERNAME/SpendWise.git"
  dest_dir: "/home/ec2-user/SpendWise"
```

### Update Instance IP
Edit `inventory.ini`:
```ini
[webserver]
spendwise-server ansible_host=YOUR_NEW_IP
```

## üêõ Troubleshooting

### Connection Issues

**Problem**: "Permission denied (publickey)"
```bash
# Check key permissions
ls -la spendwise-dev-keypair.pem
# Should be: -r-------- (0400)

# Fix if needed
chmod 400 spendwise-dev-keypair.pem
```

**Problem**: "Host key verification failed"
```bash
# Remove old host key
ssh-keygen -R <instance-ip>
```

### Deployment Issues

**Problem**: Docker service fails to start
```bash
# Check service status
ansible webserver -m command -a "systemctl status docker" -b
```

**Problem**: Permission denied running Docker commands
```bash
# Verify user is in docker group
ansible webserver -m command -a "groups ubuntu"

# Re-run the playbook to fix
ansible-playbook playbook.yml --tags "docker,permissions"
```

### Application Issues

**Problem**: Containers not running
```bash
# SSH into server and check
ssh -i spendwise-dev-keypair.pem ec2-user@<instance-ip>
cd ~/SpendWise
docker-compose ps
docker-compose logs
```

**Problem**: Port already in use
```bashubuntu
# Check what's using the port
ansible webserver -m command -a "netstat -tlnp | grep :5173" -b
```

## üìù Playbook Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `repo_url` | KofiAckah/SpendWise | GitHub repository URL |
| `dest_dir` | /home/ubuntu/SpendWise | Installation directory |

## üîê Security Notes

- ‚ö†Ô∏è **Never commit** `spendwise-dev-keypair.pem` to version control
- ‚ö†Ô∏è **Always use** `chmod 400` on private key files
- ‚ö†Ô∏è **Restrict** Security Group access in production
- ‚ö†Ô∏è **Use** environment-specific inventory files for different stages

## üìö Next Steps

After successful deployment:

1. **Verify Application**: Visit `http://<instance-ip>:5173`
2. **Check Logs**: Monitor Docker Compose logs for errors
3. **Set Up Monitoring**: Configure CloudWatch or similar monitoring
4. **Configure Domain**: Point your domain to the instance IP
5. **SSL/TLS**: Set up HTTPS using Let's Encrypt or AWS Certificate Manager

## üîÑ Re-deployment

To update the application with latest code:

```bash
# Pull latest changes and rebuild
ansible-playbook playbook.yml --tags "app,deploy"
```

## üßπ Cleanup

To stop the application:

```bash
# Stop containers
ansible webserver -m command -a "docker-compose down" -b --become-user=ec2-user \
  --extra-vars "chdir=/home/ec2-user/SpendWise"ubuntu \
  --extra-vars "chdir=/home/ubuntu/SpendWise"

# Remove application directory
ansible webserver -m file -a "path=/home/ubuntu

---

**Generated by**: Terraform + Ansible  
**Project**: SpendWise Deployment  
**Last Updated**: February 2026
