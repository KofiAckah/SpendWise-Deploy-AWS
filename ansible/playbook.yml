---
# ==============================================
# SpendWise Application Deployment Playbook
# ==============================================
# This playbook deploys the SpendWise application using Docker Compose
# on an EC2 instance running Ubuntu 22.04 LTS

- name: Deploy SpendWise Application
  hosts: webserver
  become: yes
  gather_facts: yes

  vars:
    repo_url: "https://github.com/KofiAckah/SpendWise.git"
    dest_dir: "/home/ubuntu/SpendWise"

  tasks:
    # ==============================================
    # System Update and Prerequisites
    # ==============================================
    - name: Update all packages
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes
        cache_valid_time: 3600
      tags: [system, update]

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose
          - git
          - jq
          - unzip
          - curl
        state: present
        update_cache: yes
      tags: [system, packages]

    - name: Check if AWS CLI is already installed
      ansible.builtin.command: aws --version
      register: aws_cli_check
      changed_when: false
      failed_when: false
      tags: [system, packages]

    - name: Download AWS CLI v2 installer
      ansible.builtin.get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip
        mode: '0644'
      when: aws_cli_check.rc != 0
      tags: [system, packages]

    - name: Unzip AWS CLI v2 installer
      ansible.builtin.unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp/
        remote_src: yes
      when: aws_cli_check.rc != 0
      tags: [system, packages]

    - name: Install AWS CLI v2
      ansible.builtin.command: /tmp/aws/install
      when: aws_cli_check.rc != 0
      tags: [system, packages]

    - name: Verify AWS CLI installation
      ansible.builtin.command: aws --version
      register: aws_version
      changed_when: false
      tags: [system, packages]

    - name: Display AWS CLI version
      ansible.builtin.debug:
        msg: "AWS CLI installed: {{ aws_version.stdout }}"
      tags: [system, packages]

    # ==============================================
    # Docker Service Management
    # ==============================================
    - name: Start and enable Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes
      tags: [docker, services]

    - name: Add ubuntu user to docker group
      ansible.builtin.user:
        name: ubuntu
        groups: docker
        append: yes
      tags: [docker, permissions]

    - name: Reset SSH connection to allow user group changes to take effect
      meta: reset_connection
      tags: [docker, permissions]

    - name: Verify Docker and Docker Compose installation
      ansible.builtin.command: docker-compose --version
      register: compose_version
      changed_when: false
      tags: [docker, verify]

    - name: Display Docker Compose version
      ansible.builtin.debug:
        msg: "Docker Compose installed: {{ compose_version.stdout }}"
      tags: [docker, verify]

    # ==============================================
    # Application Deployment
    # ==============================================
    - name: Check if SpendWise repository already exists
      ansible.builtin.stat:
        path: "{{ dest_dir }}"
      register: repo_check
      tags: [app, clone]

    - name: Remove existing repository if present
      ansible.builtin.file:
        path: "{{ dest_dir }}"
        state: absent
      when: repo_check.stat.exists
      tags: [app, clone]

    - name: Clone SpendWise repository
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ dest_dir }}"
        version: main
        force: yes
      become: yes
      become_user: ubuntu
      tags: [app, clone]

    - name: Set correct ownership for application directory
      ansible.builtin.file:
        path: "{{ dest_dir }}"
        owner: ubuntu
        group: ubuntu
        recurse: yes
      tags: [app, permissions]

    # ==============================================
    # Retrieve Configuration from Parameter Store
    # ==============================================
    - name: Set environment name from inventory
      ansible.builtin.set_fact:
        env_name: "{{ app_env | default('dev') }}"
        region: "{{ aws_region | default('eu-west-1') }}"
      tags: [app, config, parameters]

    - name: Retrieve database name from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/db/name" \
          --region {{ region }} --query 'Parameter.Value' --output text
      register: db_name
      changed_when: false
      tags: [app, config, parameters]

    - name: Retrieve database user from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/db/user" \
          --region {{ region }} --with-decryption --query 'Parameter.Value' --output text
      register: db_user
      changed_when: false
      no_log: true
      tags: [app, config, parameters]

    - name: Retrieve database password from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/db/password" \
          --region {{ region }} --with-decryption --query 'Parameter.Value' --output text
      register: db_password
      changed_when: false
      no_log: true
      tags: [app, config, parameters]

    - name: Retrieve backend port from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/app/backend_port" \
          --region {{ region }} --query 'Parameter.Value' --output text
      register: backend_port
      changed_when: false
      tags: [app, config, parameters]

    - name: Retrieve database host from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/app/db_host" \
          --region {{ region }} --query 'Parameter.Value' --output text
      register: db_host
      changed_when: false
      tags: [app, config, parameters]

    - name: Retrieve database port from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/app/db_port" \
          --region {{ region }} --query 'Parameter.Value' --output text
      register: db_port
      changed_when: false
      tags: [app, config, parameters]

    - name: Retrieve compose project name from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/app/compose_project_name" \
          --region {{ region }} --query 'Parameter.Value' --output text
      register: compose_project
      changed_when: false
      tags: [app, config, parameters]

    - name: Retrieve frontend port from Parameter Store
      ansible.builtin.shell: |
        aws ssm get-parameter --name "/spendwise/{{ env_name }}/app/frontend_port" \
          --region {{ region }} --query 'Parameter.Value' --output text
      register: frontend_port
      changed_when: false
      tags: [app, config, parameters]

    # ==============================================
    # Create Application .env File
    # ==============================================
    - name: Create root .env file with configuration from Parameter Store
      ansible.builtin.copy:
        dest: "{{ dest_dir }}/.env"
        content: |
          ################################################################################
          # SpendWise Application Environment Configuration
          # Auto-generated by Ansible from AWS Parameter Store
          # Environment: {{ env_name }}
          ################################################################################
          
          #------------------------------------------------------------------------------
          # Database Configuration (PostgreSQL)
          #------------------------------------------------------------------------------
          POSTGRES_DB={{ db_name.stdout }}
          POSTGRES_USER={{ db_user.stdout }}
          POSTGRES_PASSWORD={{ db_password.stdout }}
          
          #------------------------------------------------------------------------------
          # Backend API Configuration
          #------------------------------------------------------------------------------
          PORT={{ backend_port.stdout }}
          DB_HOST={{ db_host.stdout }}
          DB_PORT={{ db_port.stdout }}
          DB_NAME={{ db_name.stdout }}
          DB_USER={{ db_user.stdout }}
          DB_PASSWORD={{ db_password.stdout }}
          
          #------------------------------------------------------------------------------
          # Frontend Configuration
          #------------------------------------------------------------------------------
          VITE_API_URL=http://{{ ansible_host }}:{{ backend_port.stdout }}
          
          #------------------------------------------------------------------------------
          # Docker Configuration
          #------------------------------------------------------------------------------
          COMPOSE_PROJECT_NAME={{ compose_project.stdout }}
          
          ################################################################################
          # End of Configuration
          ################################################################################
        owner: ubuntu
        group: ubuntu
        mode: '0600'
      no_log: true
      tags: [app, config]

    - name: Display configuration summary
      ansible.builtin.debug:
        msg:
          - "Configuration retrieved from Parameter Store:"
          - "  Environment: {{ env_name }}"
          - "  Database: {{ db_name.stdout }}"
          - "  Backend Port: {{ backend_port.stdout }}"
          - "  Frontend Port: {{ frontend_port.stdout }}"
          - "  API URL: http://{{ ansible_host }}:{{ backend_port.stdout }}"
      tags: [app, config]

    # ==============================================
    # Frontend Configuration
    # ==============================================
    - name: Create frontend .env file with correct API URL
      ansible.builtin.copy:
        dest: "{{ dest_dir }}/frontend/.env"
        content: |
          # SpendWise Frontend Environment Configuration
          # Auto-generated by Ansible deployment
          
          # Backend API URL - Using EC2 public IP
          VITE_API_URL=http://{{ ansible_host }}:{{ backend_port.stdout }}
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      tags: [app, config]

    - name: Replace hardcoded localhost API URLs in App.jsx
      ansible.builtin.replace:
        path: "{{ dest_dir }}/frontend/src/App.jsx"
        regexp: 'http://localhost:5000'
        replace: 'http://{{ ansible_host }}:{{ backend_port.stdout }}'
      tags: [app, config]

    - name: Display API URL being configured
      ansible.builtin.debug:
        msg: "Frontend will connect to backend at: http://{{ ansible_host }}:{{ backend_port.stdout }}"
      tags: [app, config]

    # ==============================================
    # Docker Compose Deployment
    # ==============================================
    - name: Stop any existing containers
      ansible.builtin.command:
        cmd: docker-compose down
        chdir: "{{ dest_dir }}"
      become: yes
      become_user: ubuntu
      ignore_errors: yes
      tags: [app, deploy]

    - name: Build and start application with Docker Compose
      ansible.builtin.command:
        cmd: docker-compose up -d --build
        chdir: "{{ dest_dir }}"
      become: yes
      become_user: ubuntu
      tags: [app, deploy]

    - name: Wait for containers to be healthy
      ansible.builtin.pause:
        seconds: 10
      tags: [app, deploy]

    - name: Check running Docker containers
      ansible.builtin.command: docker ps
      become: yes
      become_user: ubuntu
      register: docker_ps
      changed_when: false
      tags: [app, verify]

    - name: Display running containers
      ansible.builtin.debug:
        msg: "{{ docker_ps.stdout_lines }}"
      tags: [app, verify]

    # ==============================================
    # Deployment Summary
    # ==============================================
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "================================================"
          - "SpendWise Application Deployed Successfully!"
          - "================================================"
          - "Application URL: http://{{ ansible_host }}"
          - "Backend API: http://{{ ansible_host }}:5000"
          - "Frontend: http://{{ ansible_host }}:5173"
          - "Repository: {{ repo_url }}"
          - "Installation Directory: {{ dest_dir }}"
          - "================================================"
      tags: [summary]
